name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Node.js
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      # Cache node_modules
      - name: Cache node modules
        uses: actions/cache@v4
        id: cache-node-modules
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Install dependencies
      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci

      # Generate Prisma Client
      - name: Generate Prisma Client
        run: npx prisma generate

      # Run linting
      - name: Run ESLint
        run: npm run lint

      # Build the project
      - name: Build project
        run: npm run build
        env:
          # Required environment variables for build
          DATABASE_URL: "file:./dev.db"
          AUTH_SECRET: "test-secret-key-for-ci-pipeline-only"
          NEXT_PUBLIC_APP_URL: "http://localhost:3000"
          # Stripe keys (dummy values for build)
          STRIPE_SECRET_KEY: "sk_test_dummy"
          STRIPE_WEBHOOK_SECRET: "whsec_dummy"
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: "pk_test_dummy"
          STRIPE_PRO_MONTHLY_PRICE_ID: "price_dummy"
          STRIPE_PRO_YEARLY_PRICE_ID: "price_dummy"

      # Upload build artifacts (optional)
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-output
          path: .next
          retention-days: 7

  # Optional: Add test job when tests are implemented
  # test:
  #   runs-on: ubuntu-latest
  #   needs: build
  #
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: 20.x
  #
  #     - name: Cache node modules
  #       uses: actions/cache@v4
  #       with:
  #         path: node_modules
  #         key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
  #
  #     - name: Install dependencies
  #       run: npm ci
  #
  #     - name: Generate Prisma Client
  #       run: npx prisma generate
  #
  #     - name: Run tests
  #       run: npm test
